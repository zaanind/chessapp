{% extends "base.html" %}
{% load static %} 

{% block title %}Live Chess Board{% endblock %}

{% block header %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="{% static 'css/chessboard-1.0.0.min.css' %}">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
          integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
          crossorigin="anonymous"></script>
  <script src="{% static 'js/chessboard-1.0.0.min.js' %}"></script>
  
  
  <style>
  
  button.btn-close {
    background-color: #fff0;
    border: none;
    font-size: 15px;
    font-weight: 700;
}

    .white-1e1d7 {
        background-color: #ebebd0 !important;
    }
    .black-3c85d {
        background-color: #779455 !important;
    }
	
	.captured-bar {
    width: 80px;
    min-height: 396px;
    background-color: #f8f9fa;
    border: 0px solid #ccc;
    padding: 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: start;
}
.captured-bar img {
    width: 32px;
    height: 32px;
    margin: 2px 0;
}


  /* Add this in your style block */
  .chessboard .square-55d63,  /* target all squares */
  .chessboard .square-3c85d {
    position: relative;
  }

  .valid-move-circle {
    position: absolute;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.3);
    pointer-events: none;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 4;
  }

	
	
	#live-bets-feed h5 {
  margin-bottom: 10px;
  font-weight: 700;
  border-bottom: 1px solid #ccc;
  padding-bottom: 5px;
}

.live-bet-message {
  padding: 6px 8px;
  border-radius: 6px;
  background: #f0f8ff;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  display: flex;
  justify-content: space-between;
  font-size: 0.85rem;
}

.live-bet-message.white {
  border-left: 4px solid #4caf50; /* green border for white side */
}

.live-bet-message.black {
  border-left: 4px solid #f44336; /* red border for black side */
}

.live-bet-message .username {
  font-weight: 700;
  color: #333;
}

.live-bet-message .amount {
  font-weight: 700;
  color: #555;
}


.tournament-popup {
    position: fixed;
    bottom: 20px;
    left: -320px;
    width: 280px;
 /*   background-color: #fff;
    border: 1px solid #ccc; */
    padding: 15px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    transition: left 0.3s ease;
    border-radius: 8px;
}

.tournament-popup.show {
    left: 20px;
}

.tournament-popup-content {
    position: relative;
}

.tournament-popup .close {
    position: absolute;
    right: 10px;
    top: 5px;
    font-size: 20px;
    cursor: pointer;
}



/* ADD THIS PART FOR PLAYER LIST UI */
#joined-players li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

#joined-players li:last-child {
  border-bottom: none;
}

.status-badge {
  font-weight: 600;
  font-size: 13px;
  padding: 2px 8px;
  border-radius: 12px;
  color: white;
  user-select: none;
}

.status-online {
  background-color: #28a745;
}

.status-offline {
  background-color: #dc3545;
}

  </style>
  
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
  <!--h1>Chess Board</h1-->
  <br>
  
  
  <center>
  
  
  
  
  
  
  
  <!-- Replace <center> with this: -->
<div style="display: flex; justify-content: center; align-items: center; ">

  <!-- White Player -->
  
  <div class="player-info" id="white-player">

  
  
  <style>
  /* Base styles for the chat cloud */
  .player-avatar {
    width: 70px;
    height: 70px;
    background-color: #ddd;
    border-radius: 50%;
    background-position: center;
    background-size: cover;
    margin: 0 auto 8px auto;
  }
  .player-info {
    display: inline-block;
    margin: 15px;
    text-align: center;
    position: relative;
  }
  .chat-cloud {
    position: absolute;
    bottom: 100%; /* Position it below the player-info container */
	 margin-bottom: 5px;
    background-color: #fff8e1; /* A light yellow for attention */
    border: 1px solid #ffecb3; /* Matching border color */
    border-radius: 12px;
    padding: 8px 12px; /* Slightly more padding */
    font-size: 14px;
    font-weight: 600; /* Bolder text */
    /* Remove text-overflow properties to allow multi-line messages */
    /* max-width: 180px;  - Keep this to control the width of the balloon */
    /* white-space: normal;  - You can explicitly set it, or just remove the nowrap */
    /* overflow: visible; - The default, so you can remove overflow: hidden */
    
    box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* More prominent shadow */
    opacity: 0;
    pointer-events: none;
    user-select: none;
    z-index: 100;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; /* Add transform transition */
    display: block; /* We'll control visibility with opacity and transform */
  }

  /* New class for the active state */
  .chat-cloud.show {
    opacity: 1;
    transform: scale(1); /* Scale up to 1 */
  }

  /* --- Specific positioning for White Player (Left Side) --- */
  #white-player .chat-cloud {
    left: 0; /* Align to the left edge of its parent container */
    transform: scale(0);
    transform-origin: left top; /* Pop out from the left top corner */
  }
  #white-player .chat-cloud.show {
    transform: scale(1);
  }

  /* --- Specific positioning for Black Player (Right Side) --- */
  #black-player .chat-cloud {
    right: 0; /* Align to the right edge of its parent container */
    transform: scale(0);
    transform-origin: right top; /* Pop out from the right top corner */
  }
  #black-player .chat-cloud.show {
    transform: scale(1);
  }
</style> 

    <div class="player-avatar" id="white-avatar"></div>
    <div id="white-username">WhiteUser</div>
    <div class="chat-cloud" id="white-chat"></div>
  </div>
  
  <!-- Status Bar -->
  <div id="status-bar" class="alert alert-secondary d-flex justify-content-between align-items-center bg-dark" style="width: 900px;">
    <div>
      <strong>You:</strong> <span id="user-color">-</span><br>
      <strong>Turn:</strong> <span id="current-turn">-</span>
    </div>
    <div>
      <strong>Checkmate:</strong> <span id="checkmates">No</span><br>
      <strong>Stalemate:</strong> <span id="stalemate">No</span>
    </div>
    <div>
      <strong>Rounds:</strong> <span id="round">-</span><br>
      <strong>Round:</strong> <span id="cround">-</span>
    </div>
    <div>
      <strong>Time:</strong> <span id="time_gm">-</span><br>
      <strong>Time Left:</strong> <span id="time_gm_left">-</span>
    </div>
    <div>
      <strong>White Bets:</strong> <span id="white_bet_total">0</span> pts<br>
      <strong>Black Bets:</strong> <span id="black_bet_total">0</span> pts
    </div>
  </div>
  
  <!-- Black Player -->
  <div class="player-info" id="black-player">
    <div class="player-avatar" id="black-avatar"></div>
    <div id="black-username">BlackUser</div>
    <div class="chat-cloud" id="black-chat"></div>
  </div>

</div>

<script>
  // Update White Player info
  function updateWhitePlayer(username, avatarURL) {
    document.getElementById('white-username').textContent = username;
    if (avatarURL) {
      document.getElementById('white-avatar').style.backgroundImage = `url(${avatarURL})`;
    }
  }

  // Update Black Player info
  function updateBlackPlayer(username, avatarURL) {
    document.getElementById('black-username').textContent = username;
    if (avatarURL) {
      document.getElementById('black-avatar').style.backgroundImage = `url(${avatarURL})`;
    }
  }

  // Show chat bubble for White player (floating popup)
  function showWhiteChat2(message) {
    const chatBubble = document.getElementById('white-chat');
    chatBubble.textContent = message;
    chatBubble.style.display = 'block';   // show it
    setTimeout(() => {
      chatBubble.style.opacity = '1';     // fade in
    }, 10);

    setTimeout(() => {
      chatBubble.style.opacity = '0';     // fade out
      setTimeout(() => {
        chatBubble.style.display = 'none';  // hide after fadeout
      }, 500);  // match CSS transition duration
    }, 4000);
  }

  // Show chat bubble for Black player (floating popup)
  function showBlackChat2(message) {
    const chatBubble = document.getElementById('black-chat');
    chatBubble.textContent = message;
    chatBubble.style.display = 'block';
    setTimeout(() => {
      chatBubble.style.opacity = '1';
    }, 10);

    setTimeout(() => {
      chatBubble.style.opacity = '0';
      setTimeout(() => {
        chatBubble.style.display = 'none';
      }, 500);
    }, 4000);
  }


// Show chat bubble for White player (floating popup)
function showWhiteChat(message) {
  const chatBubble = document.getElementById('white-chat');
  chatBubble.textContent = message;

  // Add the 'show' class to trigger the pop-in effect
  chatBubble.classList.add('show');

  // Hide the bubble after a few seconds
  setTimeout(() => {
    // Remove the 'show' class to trigger the pop-out effect
    chatBubble.classList.remove('show');
  }, 4000); // Wait 4 seconds before starting the fade out

  // After the fade out transition is complete, ensure it's hidden from screen readers
  setTimeout(() => {
    chatBubble.textContent = ''; // Clear content
  }, 4500); // 4000ms wait + 500ms transition
}

// Show chat bubble for Black player (floating popup)
function showBlackChat(message) {
  const chatBubble = document.getElementById('black-chat');
  chatBubble.textContent = message;

  chatBubble.classList.add('show');

  setTimeout(() => {
    chatBubble.classList.remove('show');
  }, 4000);

  setTimeout(() => {
    chatBubble.textContent = '';
  }, 4500);
}

  updateWhitePlayer('', '{% static 'img/profile-user.png' %}');
  updateBlackPlayer('', '{% static 'img/profile-user.png' %}');

  // Example usage:
 // updateWhitePlayer('Alice', 'https://example.com/alice.jpg');
 // updateBlackPlayer('Bob', 'https://example.com/bob.jpg');
//  showWhiteChat('Your move!');
  //showBlackChat('Good luck!');
</script>

  
  
  
  
  
  
  
  
  
  
</center>


<div class="d-flex  align-items-start">


  <!-- Live Bets Feed on Left   justify-content-center -->
  <div id="live-bets-feed" style="
       width: 220px;
       max-height: 500px;
       margin-left:10px;
       overflow-y: auto;
       /* border: 1px solid #ddd; */
       /* background: #fefefe; */
       padding: 10px;
       margin-right: 20px;
       font-family: monospace;
       font-size: 0.9rem;
       ">
    <h5>Live Bets</h5>
    <div id="live-bets-container" style="display: flex; flex-direction: column; gap: 6px;">
      <!-- Bet messages appended here -->
    </div>
  </div>
  
  
    <div id="black-captured" class="captured-bar  text-center"></div>
  <div id="board" style="width: 395px;"></div>
  
    <div id="white-captured" class="captured-bar text-center"></div>
</div>





  <div id="notification-container" style="position: fixed; top: 90px; left: 20px; z-index: 1055;"></div>


  <!-- Bet Button -->
  <button id="betButton" class="btn btn-warning rounded-circle" title="Place Bet" style="width: 60px;height: 60px;position: fixed;font-size: 18px;right: 100px;bottom: 20px;box-shadow: 0 5px 15px rgb(0 0 0 / 30%);">
    <i class="fas fa-coins"></i>
  </button>

<!-- Floating Chat Icon -->
<div class="chat-toggle" id="chatToggle">
  💬
</div>

{% if is_agent %}
  <button class="btn btn-sm btn-dark" id="openTournamentManager" style="position: fixed; bottom: 5px; right: 300px; z-index: 999;">
    🏁 Manage Tournament
  </button>
{% endif %}


{% if is_tournament %}
 <a href="{% url 'room_pairings' %}?id={{ room_id }}">
  <button class="btn btn-sm btn-dark" style="position: fixed; bottom: 5px; right: 600px; z-index: 999;">
    🏁 View Player's Pairings
  </button>
    </a>
{% endif %}


<!-- Chat Box -->
<div class="chat-box bg-dark d-flex flex-column d-none" id="chatBox">
  <div class="chat-header">
    Chat
    <svg class="chat-close-btn" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-label="Close chat" role="button" tabindex="0">
      <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.89 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"/>
    </svg>
  </div>
  
  
  <div class="chat-messages" id="chatMessages"></div>
    <div id="predefined-messages">


<script>
  $(function () {

    $('#predefined-messages').on('click', '.predefined-msg-btn', function() {
	
	
	
    //  const message = $(this).data('message');
	
	  const message = $(this).text(); 


      if (message && socket?.readyState === WebSocket.OPEN) {
        // Directly send the message via WebSocket
        socket.send(JSON.stringify({ type: "chat", message: message }));
        

        $('#messageInput').val(''); 
      } else {
        console.warn("WebSocket not open. Cannot send message.");
        showNotification("Cannot send message. Not connected to chat.", "warning");
      }
    });

  });
</script>

<style>
/* --- CSS for Predefined Message Buttons --- */
#predefined-messages {
  /* ADD THESE TWO LINES */
  /*  max-height: 145px;  Set a max height (e.g., for ~3 rows of buttons) */
  overflow-y: auto;   /* Add a vertical scrollbar only when needed */
  height:230px; 

  /* --- Existing styles --- */
  padding: 8px 10px;
  border-top: 1px solid #ddd;

  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.predefined-msg-btn {
  border: 1px solid #ccc;

  border-radius: 12px;
  padding: 3px 10px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.predefined-msg-btn:hover {
}
</style>


    <button class="predefined-msg-btn" >GL!</button>
    <button class="predefined-msg-btn">Nice move!</button>
    <button class="predefined-msg-btn">Well played</button>
    <button class="predefined-msg-btn">You took my pawn?!</button>
    <button class="predefined-msg-btn">Seriously?!</button>
    <button class="predefined-msg-btn" >Bold move!</button>
    <button class="predefined-msg-btn" >Thinking...</button>
    <button class="predefined-msg-btn" >Hurry up!</button>
    <button class="predefined-msg-btn">Oops!</button>
    <button class="predefined-msg-btn">In trouble...</button>
    <button class="predefined-msg-btn">Check!</button>
    <button class="predefined-msg-btn">Good game</button>
  </div>
  
  <div class="chat-input">
    <div class="input-group">
      <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
      <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>


<!-- Tournament Manager Popup -->
<div id="tournamentManagerPopup" class="tournament-popup bg-dark">
  <div class="tournament-popup-content">
    <span id="closeTournamentPopup" class="close">&times;</span>
    <h5>Tournament Manager</h5>
<!-- Copy Join Link -->
<div class="input-group mb-3">
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const copyBtn = document.getElementById('copyJoinLinkBtn');
    const input = document.getElementById('joinLinkInput');

    // Generate the join URL dynamically if needed
    if (input && window.location.href.includes('/board/')) {
      const currentBoardUrl = window.location.origin + '/board/';
      const roomId = window.location.pathname.split('/').filter(Number).pop(); // extract room_id from URL
      input.value = `${currentBoardUrl}join/tournament/{{room_id}}/`;
    }

    copyBtn?.addEventListener('click', () => {
      input.select();
      input.setSelectionRange(0, 99999); // for mobile devices

      try {
        document.execCommand('copy');
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>

  <input type="text" id="joinLinkInput" class="form-control" readonly
    value="{{ request.build_absolute_uri }}/join/tournament/{{ room_id }}/">
  <button class="btn btn-outline-primary" type="button" id="copyJoinLinkBtn">
    <i class="fas fa-copy"></i> Copy
  </button>
</div>
<hr style="margin-top: 20px; margin-bottom: 15px; border-top: 1px solid #ccc;" />
    <div class="mb-2">
      <strong>Players Joined:</strong> <span id="players-count">0</span> / <span id="players-total">-</span>
   <br>   <strong>Players Online:</strong> <span id="players-count-online">0</span> / <span id="players-total-online">-</span>
    </div>

    <ul id="joined-players" class="list-group mb-2" style="max-height: 150px; overflow-y: auto;">
      <!-- Players will be appended here -->
    </ul>

    <button class="btn btn-primary w-100" id="startGameBtn">Start Game</button>
  </div>
</div>


{% if is_agent %}
<script>
// Tournament Manager popup logic
const tournamentPopup = document.getElementById("tournamentManagerPopup");
const openBtn = document.getElementById("openTournamentManager");
const closeBtn = document.getElementById("closeTournamentPopup");

openBtn.addEventListener("click", () => {
  tournamentPopup.classList.toggle("show");
});

closeBtn.addEventListener("click", () => {
  tournamentPopup.classList.remove("show");
});









function updateTournamentManagerUI(joinedPlayers, maxPlayers) {
  const playerList = document.getElementById("joined-players");
  const countSpan = document.getElementById("players-count");
  const totalSpan = document.getElementById("players-total");

  const countSpanonline = document.getElementById("players-count-online");
  const totalSpanonline = document.getElementById("players-total-online");

  if (!playerList || !countSpan || !totalSpan || !countSpanonline || !totalSpanonline) return;

  playerList.innerHTML = '';
  countSpan.textContent = joinedPlayers.length;
  totalSpan.textContent = maxPlayers;

  let onlineCount = 0;

  joinedPlayers.forEach(player => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center py-1 px-2';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = player.username || player;

    const isOnline = player.is_online ?? false;

    const statusSpan = document.createElement('span');
    statusSpan.className = 'badge ' + (isOnline ? 'bg-success' : 'bg-secondary');
    statusSpan.textContent = isOnline ? 'Online' : 'Offline';

    if (isOnline) onlineCount++;

    li.appendChild(nameSpan);
    li.appendChild(statusSpan);
    playerList.appendChild(li);
  });

  const toOnline = joinedPlayers.length - onlineCount;

  countSpanonline.textContent = onlineCount;
  totalSpanonline.textContent = maxPlayers;
  console.log(joinedPlayers.length, onlineCount);
}




// Start game click
document.getElementById("startGameBtn").addEventListener("click", () => {
  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: "tournament_start" }));
  }
  //showNotification("Tournament started!", "success");
});
</script>
{% endif %}


<!-- Modal -->
<div class="modal fade" id="gameAlertModal" tabindex="-1" aria-labelledby="gameAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gameAlertModalLabel">Notification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="gameAlertModalBody">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Okay</button>
      </div>
    </div>
  </div>
</div>


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  $(function () {
    // Toggle chat visibility
    $('#chatToggle').on('click', function () {
      $('#chatBox').toggleClass('d-none');
    });
	
	
	

    // Close chat box
    $('.chat-close-btn').on('click', function () {
      $('#chatBox').addClass('d-none');
    });

    // Send button click
    $('#sendBtpn').on('click', function () { //disabled signals 
      let message = $('#messageInput').val().trim();
      if (message !== '') {
        addOwnMessage(message);
        $('#messageInput').val('');
        scrollToBottom();
      }
    });

    // Enter key to send
    $('#messageInput').keypress(function (e) {
      if (e.which === 13) {
        $('#sendBtn').click();
      }
    });

    function scrollToBottom() {
      $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
    }

    // Incoming message function
    window.addIncomingMessage = function(name, message) {
      $('#chatMessages').append(`
        <div class="clearfix">
          <div class="message other float-start">
            <span class="sender text-primary">${name}</span>
            ${message}
          </div>
        </div>
      `);
      scrollToBottom();
    };

    // Own message function (no name)
    window.addOwnMessage = function(message) {
      $('#chatMessages').append(`
        <div class="clearfix">
          <div class="message you float-end">
            ${message}
          </div>
        </div>
      `);
      scrollToBottom();
    };
  });



</script>
  <script>
  
  function addLiveBetMessage(username, side, amount) {
  const container = document.getElementById('live-bets-container');

  // Create the message div
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('live-bet-message');
  messageDiv.classList.add(side.toLowerCase());

  // Compose inner HTML
  messageDiv.innerHTML = `
    <span class="username">${username}</span>
    <span class="amount">${amount} pts</span>
  `;

  // Append new message on top
  container.prepend(messageDiv);

  // Optional: limit to last 30 messages
  if (container.children.length > 30) {
    container.removeChild(container.lastChild);
  }
}



  
  
    function showNotification(message, type = 'primary', duration = 5000) {
        const id = 'notif-' + Date.now();
        const alert = $(`
            <div id="${id}" class="alert alert-${type} alert-dismissible fade show" role="alert" style="min-width: 250px; ">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        $('#notification-container').append(alert);
        setTimeout(() => {
            alert.alert('close');
        }, duration);
    }
	
	
	
	
	function showGameModal2(message, title = "Notification") {
  $('#gameAlertModalLabel').text(title);
  $('#gameAlertModalBody').html(message);
  const modal = new bootstrap.Modal(document.getElementById('gameAlertModal'));
  modal.show();
}

function showGameModal(message, title = "Notification") {
  $('#gameAlertModalLabel').text(title);
  $('#gameAlertModalBody').html(message);

  const modalEl = document.getElementById('gameAlertModal');
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
}




  </script>
  
  
<script>
const isViewOnly = {{ is_view_only|yesno:"true,false" }};
const gameId = "{{ game_id }}";
const pieceTheme = '{% static "/img/chesspieces/wikipedia/" %}{piece}.png';


let roundTimeLeft = 0;
let roundCountdownInterval = null;


let socket = null;
let board = null;
let boardPosition = 'start';
let legalMoves = [];
let boardLocked = true;
let userColor = null;


let lastActivityTime = Date.now();
let inactivityCheckInterval = null;
sent15SecSignal = false;
sent30SecSignal = false;
function resetInactivityTimer() {
  lastActivityTime = Date.now();
  sent15SecSignal = false;
  sent30SecSignal = false;
}




// Check inactivity every 1 second
function startInactivityChecker() {
  clearInterval(inactivityCheckInterval);
  inactivityCheckInterval = setInterval(() => {
    const now = Date.now();
    const inactiveSeconds = (now - lastActivityTime) / 1000;

    if (inactiveSeconds >= 15 && !sent15SecSignal) {
      sent15SecSignal = true;
      console.log("Passed 15 seconds inactivity");
      send_inactivity_report(15);
    }

    if (inactiveSeconds >= 30 && !sent30SecSignal) {
      sent30SecSignal = true;
      console.log("Passed 30 seconds inactivity");
      send_inactivity_report(30);
    }

  }, 1000);
}

// Check inactivity every 10 seconds
function startInactivityChecker2() {      //-------------old-------------
  clearInterval(inactivityCheckInterval);
  inactivityCheckInterval = setInterval(() => {
    const now = Date.now();
    const inactiveSeconds = (now - lastActivityTime) / 1000;

    if (inactiveSeconds >= 10) {
      console.log(inactiveSeconds);
      // Optional: showNotification("No activity for 30 seconds", "warning");
	  
	  send_inactivity_report();
	  
	  
    }
  }, 1000);
}


function initBoard() {
  board = Chessboard('board', {
    draggable: true,
    position: boardPosition,
    pieceTheme: pieceTheme,
    onDragStart: function (source, piece, position, orientation) {
      if (isViewOnly || boardLocked || piece[0] !== userColor[0]) {
        return false;
      }
      highlightValidMoves(source);
    },
    onDrop: function (source, target) {
      clearValidMoveMarkers();
      return handleMove(source, target);
    },
    onSnapEnd: function () {
      clearValidMoveMarkers();
    }
  });
}





function handleMove(source, target) {
  if (isViewOnly) {
    showNotification("Board is view-only. You can't move.", "warning");
    return 'snapback';
  }

  if (boardLocked) {
    showNotification("Not your turn. Cannot move.", "warning");
    return 'snapback';
  }
  
    // Ignore same-square moves
  if (source === target) {
    return;
  }

  const moveStr = source + target;
  if (!legalMoves.includes(moveStr)) {
    showNotification("Illegal move: " + moveStr, "danger");
    return 'snapback';
  }

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ move: moveStr }));
  } else {
    console.warn("WebSocket not open.");
  }
}

function connectSocket() {
 

  const wsScheme = window.location.protocol === "https:" ? "wss://" : "ws://";
  socket = new WebSocket(`${wsScheme}${window.location.host}/ws/chess/${gameId}/`);

  socket.onopen = () => {
    console.log("WebSocket connected");
	startInactivityChecker();
    showNotification("Connected to server", "success");
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("Received:", data);

    if (data.error) {
      showNotification(data.error, "danger");
      return;
    }
	
	

if (data.popup) {
  let msgstr = data.popup;

  if (data.state === 'over') {
    clearInterval(inactivityCheckInterval); // stop inactivity check
    boardLocked = true;

    if (data.winner) {
      msgstr += '<br>Winner : ' + data.winner.toUpperCase(); // assuming you want it in uppercase
    }

    showGameModal(msgstr, "Game Over");
    stopRoundCountdown();

  } else if (data.state === 'next_round') {
    boardLocked = true;
    showGameModal(msgstr, "Next Round Started");
    stopRoundCountdown();

  } else {
    showGameModal(msgstr, "Alert");
  }
}


       if (data.total_rounds) {
            document.getElementById("round").textContent = data.total_rounds;
        }
        if (data.current_round) {
            document.getElementById("cround").textContent = data.current_round;
        }

	
	        // 1. Update player profile names
        if (data.white_player_username) {
            updateWhitePlayer(data.white_player_username, '{% static 'img/profile-user.png' %}');
        }
        if (data.black_player_username) {
            updateBlackPlayer(data.black_player_username, '{% static 'img/profile-user.png' %}');
        }
		
		
		
		
		if (data.type === 'chat') {
        const whiteUsername = document.getElementById('white-username').textContent;
        const blackUsername = document.getElementById('black-username').textContent;

        if (data.sender === whiteUsername) {
            showWhiteChat(data.message);
        } else if (data.sender === blackUsername) {
            showBlackChat(data.message);
        } 
    }
	
	
	
	if (data.round !== undefined && data.time_clock !== undefined) {
	resetInactivityTimer();
	
  startRoundCountdown(parseInt(data.time_clock));
  
  if(data.max_time_per_round){
  
   document.getElementById("time_gm").textContent = data.max_time_per_round + "s";
  
  }
  

}

	

    if (data.user_color) { // && !userColor
      userColor = data.user_color;
      board.orientation(userColor);
      document.getElementById("user-color").textContent = userColor;
    }

    if (typeof data.turn === "string") {
      document.getElementById("current-turn").textContent = data.turn;
      if (!isViewOnly && userColor) {
	  
	   if (data.checkmate === false && data.stalemate === false){
   //     boardLocked = data.turn !== userColor;
       // showNotification(boardLocked ? "Opponent's turn" : "Your turn", boardLocked ? "secondary" : "success");
		
		} 

		}
    }
	
	
	
	if(data.cplayer){
	msg = data.cplayer+" turn. ("+data.turn+")" 
	showNotification(msg, "success");
	
	}

    if (data.legal_moves && Array.isArray(data.legal_moves)) {
      legalMoves = data.legal_moves;
    }

    if (data.fen) {
      boardPosition = data.fen;
      board.position(boardPosition);
      updateCapturedPieces(boardPosition);
    }

    if (data.move?.length === 4 && !data.move.includes("-")) {
      const formattedMove = `${data.move.slice(0, 2)}-${data.move.slice(2, 4)}`;
      board.move(formattedMove);
	  
    }
	
	  if (data.locked == true) {
	  resetInactivityTimer();

	 boardLocked = true;
  }
  
   if (data.locked == false) {
   // Reset inactivity timer on any new board update
    resetInactivityTimer();


	 boardLocked = false;
  }
	
	  if (data.checkmate == true) {
    document.getElementById("checkmates").textContent = data.checkmate ? "Yes" : "No";
	//send_checkmate();
	 showNotification("Checkmate!", "info");
	 boardLocked = true;
  }
  
  if (data.stalemate == true) {
    document.getElementById("stalemate").textContent = data.checkmate ? "Yes" : "No";
	 showNotification("Game Drawn by Stalemate", "info");
	  boardLocked = true;
 
 }
 
 if (data.type2 === "user_joined_tman") { 
  updateTournamentManagerUI(data.joined, data.max);
}



	

        if (data.white_player_username) {
		console.log('gotit');
		console.log(data.white_player_username);
        
        }
     
		
		
		
 
 if (data.type === "bet") {
 // const sideDiv = data.side === "white" ? "#whiteBets" : "#blackBets";
  //const name = data.is_bot ? "[BOT] " + data.username : data.username;
  //const html = `<div class="text-muted small mb-1">${name}: <strong>${data.amount}</strong></div>`;
  //$(sideDiv).append(html);

       addLiveBetMessage( data.username, data.side,data.amount );


const side = data.side.toLowerCase();  // Normalize to lowercase
const totalSpan = side === "white" ? "#white_bet_total" : "#black_bet_total";

const oldTotal = parseFloat($(totalSpan).text()) || 0;
const newAmount = parseFloat(data.amount) || 0;

$(totalSpan).text((oldTotal + newAmount).toFixed(2));

}

 
 if (data.type === "chat") {
  if (data.sender === undefined || data.sender === null) return;
  if (data.sender === "{{ request.user.username }}") {
    addOwnMessage(data.message);
  } else {
    addIncomingMessage(data.sender, data.message);
  }
  return;
}

    if (data.ui_ref === 'ui_notification') {
      addNotification(data.message, data.icon || 'fa-info-circle',data.notif_link);
    }

 
 
   if (data.type === 'opponent_offline') {
        showNotification(data.message, "danger");
    }
	
	
  };

  socket.onclose = () => {
  clearInterval(inactivityCheckInterval);
  	clearNotifications();

  
      // 🧹 Clear chat messages
    $('#chat-messages').empty();

    // 🧹 Clear live bet messages
    $('#live-bets-container').empty();

    // 🧹 Reset bet totals
    $('#white_bet_total').text('0');
    $('#black_bet_total').text('0');

    // 🧹 Optional: reset user color, turn, etc.
    $('#user-color').text('-');
    $('#time_gm').text('-');
    $('#time_gm_left').text('-');

	
    $('#current-turn').text('-');
    $('#checkmates').text('No');
    $('#stalemate').text('No');
    showNotification("WebSocket disconnected. Reconnecting...", "warning");
    setTimeout(connectSocket, 1000);
  };

  socket.onerror = (err) => {
    console.error("WebSocket error:", err);
    socket.close();
  };
}

function clearValidMoveMarkers() {
  $('.valid-move-circle').remove();
}

function highlightValidMoves(square) {
  clearValidMoveMarkers();
  const movesFromSquare = legalMoves.filter(m => m.startsWith(square));
  for (const move of movesFromSquare) {
    const targetSquare = move.slice(2, 4);
    const squareEl = $(`#board .square-${targetSquare}`);
    const marker = $('<div class="valid-move-circle"></div>');
    squareEl.append(marker);
  }
}

initBoard();
connectSocket();

let previousPieces = {};

function updateCapturedPieces(fen) {
  const pieceThemeBase = pieceTheme.replace('{piece}.png', '');
  const currentPieces = {
    w: { p: 0, r: 0, n: 0, b: 0, q: 0 },
    b: { p: 0, r: 0, n: 0, b: 0, q: 0 }
  };

  const fenBoard = fen.split(' ')[0];
  for (const c of fenBoard) {
    if ('prnbqkPRNBQK'.includes(c)) {
      const color = c === c.toLowerCase() ? 'b' : 'w';
      const piece = c.toLowerCase();
      if (piece !== 'k') currentPieces[color][piece]++;
    }
  }

  const standardCount = { p: 8, r: 2, n: 2, b: 2, q: 1 };

  const whiteCaptured = [];
  const blackCaptured = [];

  for (const [type, count] of Object.entries(standardCount)) {
    const missingWhite = count - currentPieces.w[type];
    const missingBlack = count - currentPieces.b[type];

    for (let i = 0; i < missingWhite; i++) {
      blackCaptured.push(`<img src="${pieceThemeBase}w${type.toUpperCase()}.png" alt="${type}">`);
    }
    for (let i = 0; i < missingBlack; i++) {
      whiteCaptured.push(`<img src="${pieceThemeBase}b${type.toUpperCase()}.png" alt="${type}">`);
    }
  }
  
  function groupCapturedPieces(pieces) {
  const rows = [];
  for (let i = 0; i < pieces.length; i += 2) {
    const row = `<div class="d-flex justify-content-center">${pieces[i]}${pieces[i + 1] || ''}</div>`;
    rows.push(row);
  }
  return rows.join('');
}

document.getElementById("black-captured").innerHTML = groupCapturedPieces(blackCaptured);
document.getElementById("white-captured").innerHTML = groupCapturedPieces(whiteCaptured);


 // document.getElementById("black-captured").innerHTML = blackCaptured.join('');
  //document.getElementById("white-captured").innerHTML = whiteCaptured.join('');
}

</script>



<script>

function send_checkmate(){

console.log('checkmate to backend');

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: "checkmate_respond" }));
  } else {
    console.warn("WebSocket not open");
  }




}


function send_ws_time_end(){

console.log('time end msg sent to backend');

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: "clock_end" }));
  } else {
    console.warn("WebSocket not open");
  }


}



function send_inactivity_report(){

console.log('inactivity reported to ws');

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: "no_activity" }));
  } else {
    console.warn("WebSocket not open");
  }

}



function startRoundCountdown(seconds) {
  clearInterval(roundCountdownInterval);
  roundTimeLeft = seconds;
  document.getElementById("time_gm_left").textContent = roundTimeLeft + "s";
  
  roundCountdownInterval = setInterval(() => {
    roundTimeLeft--;
    if (roundTimeLeft <= 0) {
      clearInterval(roundCountdownInterval);
      document.getElementById("time_gm_left").textContent = "0s";
	  send_ws_time_end();
	  
    } else {
      document.getElementById("time_gm_left").textContent = roundTimeLeft + "s";
    }
  }, 1000);
}

function stopRoundCountdown() {
  if (roundCountdownInterval !== null) {
    clearInterval(roundCountdownInterval);
    roundCountdownInterval = null;
    document.getElementById("time_gm_left").textContent = "-"; // optional: clear timer display
  }
}

//sending msgs


$('#sendBtn').on('click', function () {
  let message = $('#messageInput').val().trim();
  if (message !== '') {
    if (socket?.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({ type: "chat", message: message }));
    } else {
      console.warn("WebSocket not open");
    }
    $('#messageInput').val('');
    //scrollToBottom();
  }
});



</script>



<!-- Popup -->
<div id="betPopup" class="bet-popup bg-dark ">
    <div class="bet-popup-content">
        <span id="closeBetPopup" class="close">&times;</span>



        <h5>Place Bet</h5>
		    <div class="mt-3">
      <button class="btn btn-sm btn-outline-primary" data-mdb-toggle="modal" data-mdb-target="#betInviteModal">
        Challenge to Bet
      </button>
    </div>
			    <!-- Separator -->
    <hr style="margin-top: 20px; margin-bottom: 15px; border-top: 1px solid #ccc;" />
	
	
        <form  id="betForm"  method="POST" action="#" >
	{% if bet_locked %}
  <div id="betAlert" class="alert alert-info mb-3">
    You are <strong>responding to a bet challenge</strong>. Your side has been auto-selected.
  </div>
{% endif %}

		      <label>Team:</label>
			  <Select class="form-control mb-2" name='team' required id="team-select" 	{% if bet_locked %} disabled {% endif %} >
    <option value="" >Select</option>
    <option value="White" {% if preselected_team == "White" %}selected{% endif %}>White</option>
    <option value="Black" {% if preselected_team == "Black" %}selected{% endif %}>Black</option>
</Select>

            <!--Select class="form-control mb-2"  name='team' required>
			    <option value="" disabled selected hidden>Select</option>
    <option value="White">White</option>
    <option value="Black">Black</option>
			
			</Select-->
		
            <label>Amount:</label>
            <input required type="number" step="any"  class="form-control mb-2" placeholder="Enter amount">
			
            <button type="submit" class="btn btn-success">Place Your Bet</button>
        </form>
		
<script>
document.getElementById('betForm').addEventListener('submit', function(e) {
    const alertBox = document.getElementById('betAlert');
    if (alertBox) {
        alertBox.remove(); // instantly remove the alert if it exists
    }
});
</script>
    </div>
</div>


<!-- Bet Invite Modal --> 
<div class="modal fade" id="betInviteModal" tabindex="-1" aria-labelledby="betInviteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="betInviteLabel">Challenge User to Bet</h5>
        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
      </div>
	  
	  
			      <label>User To Challenge:</label>
      <div class="modal-body position-relative">
        <input 
          type="text" 
          class="form-control mb-2" 
          id="bet-invite-search" 
          placeholder="Search username..." 
          oninput="searchUsers(this.value, 'bet')"
          autocomplete="off"
        >
		        <ul id="bet-suggest-user-list" class="list-group position-absolute w-100" style="z-index: 1050;"></ul>
		
			      <label>Team:</label>
            <Select class="form-control mb-2" id="my-bet-team" required>
			    <option value="" disabled selected hidden>Select</option>
    <option value="White">White</option>
    <option value="Black">Black</option>
			
			</Select>
			
			
 <label>Amount:</label>
	 <input 
          type="number" 
          class="form-control mb-2" 
          id="bet-invite-my-bet" 
          placeholder="Enter bet amount..." 
required
          autocomplete="off"
        >
		
		
		<input type="hidden" id="bet-invite-user-id">


        <button class="btn btn-success mt-2" id="send-bet-invite">Send Challenge</button>
      </div>
    </div>
  </div>
</div>

<!-- Tournament Invite -->
<div class="modal fade" style="max-width: 300px;">
  <h6 class="text-primary">Invite User to Tournament</h6>
  <div class="input-group">
    <input 
      type="text" 
      class="form-control" 
      id="tournament-invite-search" 
      placeholder="Search username..." 
      oninput="searchUsers(this.value, 'tournament')" 
      autocomplete="off"
    >
	<input type="hidden" id="tournament-invite-user-id">

  </div>
  <ul id="tournament-suggest-user-list" class="list-group position-absolute w-100" style="z-index: 1050;"></ul>
  <button class="btn btn-sm btn-primary mt-2" id="invite-user-btn">Invite</button>
</div>

<style>

.chat-messages {

    max-height: 205px;

}



  #bet-suggest-user-list li,
  #tournament-suggest-user-list li {
    background-color: white !important;
    color: black;
    cursor: pointer;
    z-index: 1060;


  }

  #bet-suggest-user-list,
  #tournament-suggest-user-list {
    max-height: 200px;
    overflow-y: auto;
  }

  .modal-body {
    position: relative;
  }

  /* Container list styling */
  #bet-suggest-user-list,
  #tournament-suggest-user-list {
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #888 #f1f1f1; /* Firefox */
  }

  /* Chrome, Edge, Safari scrollbar styling */
  #bet-suggest-user-list::-webkit-scrollbar,
  #tournament-suggest-user-list::-webkit-scrollbar {
    width: 8px;
  }

  #bet-suggest-user-list::-webkit-scrollbar-track,
  #tournament-suggest-user-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }

  #bet-suggest-user-list::-webkit-scrollbar-thumb,
  #tournament-suggest-user-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  #bet-suggest-user-list::-webkit-scrollbar-thumb:hover,
  #tournament-suggest-user-list::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

<script>
function showSuggestions(results) {
  const betInput = document.getElementById('bet-invite-search');
  const tournamentInput = document.getElementById('tournament-invite-search');
  let listElement, inputElement, hiddenInput;

  if (document.activeElement === betInput) {
    listElement = document.getElementById('bet-suggest-user-list');
    inputElement = betInput;
    hiddenInput = document.getElementById('bet-invite-user-id');
  } else if (document.activeElement === tournamentInput) {
    listElement = document.getElementById('tournament-suggest-user-list');
    inputElement = tournamentInput;
    hiddenInput = document.getElementById('tournament-invite-user-id');
  } else {
    return;
  }

  listElement.innerHTML = '';

  results.forEach(user => {
    const li = document.createElement('li');
    li.className = 'list-group-item list-group-item-action';
    li.textContent = user.username;
    li.title = user.username; // Tooltip for full name

    li.onclick = () => {
      inputElement.value = user.username;
      hiddenInput.value = user.id;
      listElement.innerHTML = '';
    };

    listElement.appendChild(li);
  });
}



$('#betPopup form').on('submit', function(e) {
  e.preventDefault();
  
  const team = $(this).find('[name="team"]').val();
  const amount = $(this).find('input[type="number"]').val();

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({ type: "bet", amount: amount, side: team }));
  } else {
    console.warn("WebSocket not open");
  }

  console.log("Bet submitted:", team, amount);
    $('#betPopup').removeClass('show'); // Hide popup
  //this.reset();  // Clear form
    setTimeout(() => this.reset(), 300);  // Adjust time as needed

});


async function searchUsers(query) {
  if (query.length < 2) {
    showSuggestions([]);  // Clear suggestions if less than 2 chars
    return;
  }
  
  try {
    const response = await fetch(`/board/api/search-users/?q=${encodeURIComponent(query)}`);
    if (!response.ok) {
      console.error('Network response was not ok');
      showSuggestions([]);
      return;
    }
    const data = await response.json();
    showSuggestions(data.results);  // Your function to update the suggestion list UI
  } catch (error) {
    console.error('Fetch error:', error);
    showSuggestions([]);
  }
}

document.getElementById('send-bet-invite').addEventListener('click', () => {
  const userId = document.getElementById('bet-invite-user-id').value;
  const team = document.getElementById('my-bet-team').value;
  const amount = document.getElementById('bet-invite-my-bet').value;

  if (!userId || !team || !amount) {
    alert("All fields are required.");
    return;
  }

  if (socket?.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      type: 'bet_invite_notification',
      to_user_id: userId,
      bet_team: team,
      bet_amount: amount
    }));
  }
});



</script>

<script>



  const betBtn = document.getElementById("betButton");
  const betPopup = document.getElementById("betPopup");
  const closePopup = document.getElementById("closeBetPopup");

  // Toggle popup visibility
  betBtn.onclick = function () {
    betPopup.classList.toggle("show");
  };

  // Close button
  closePopup.onclick = function () {
    betPopup.classList.remove("show");
  };

  // Optional: validate using form's native check
  betPopup.querySelector("form").onsubmit = function (e) {
    if (!this.checkValidity()) {
      // Let the browser show its native validation messages
      e.preventDefault();
      this.reportValidity();
    }
  };
  
  
  
  
  
  
  
</script>



<style>
.bet-popup {
    position: fixed;
    bottom: 20px;
    left: -300px; /* hidden initially */
    width: 260px;
 /*   background-color: #fff;
    border: 1px solid #ccc; */
    padding: 15px;
    z-index: 9999;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    transition: left 0.3s ease;
    border-radius: 8px;
}

.bet-popup.show {
    left: 20px; /* visible position */
}

.bet-popup-content {
    position: relative;
}

.bet-popup .close {
    position: absolute;
    right: 10px;
    top: 5px;
    font-size: 20px;
    cursor: pointer;
}










    body {
     /* background: #f0f2f5; */
    }

    .chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #0d6efd;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      color: white;
      font-size: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .chat-box {
	
      max-height: 375px; 
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 320px;

  
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      flex-direction: column;
      overflow: hidden;
      z-index: 998;
      animation: fadeInUp 0.3s ease-in-out;
    }

    @keyframes fadeInUp {
      0% {
        transform: translateY(20px);
        opacity: 0;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .chat-header {
      background: #0d6efd;
      color: white;
      padding: 10px 15px;
      font-weight: bold;
      position: relative;
      user-select: none;
    }

    .chat-close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      fill: white;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .chat-close-btn:hover {
      opacity: 1;
    }

    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;

    }

    .chat-input {
      border-top: 1px solid #ddd;
      padding: 10px;
    }

    .message {
   /*   max-width: 80%;  */
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 15px;
      clear: both;
      display: inline-block;
      word-wrap: break-word;
    }

    .message.you {
      background-color: #d1e7dd;
      float: right;
      text-align: right;
    }

    .message.other {
      background-color: #f1f1f1;
      float: left;
      text-align: left;
    }

    .message .sender {
      font-weight: bold;
      display: block;
    }
	
	
	.alert-secondary {
    background-color: #bbc2c9;

}

  </style>






  

  
{% endblock %}
